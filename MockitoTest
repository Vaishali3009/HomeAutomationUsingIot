  @Override
    public void retrieveCustomer(RetrievePrimaryCustomerForArrRequest request, WebServiceMessage message) {
        try { RequestParams params = extractParams(request);
            XPath xpath = XPathFactory.newInstance().newXPath();
            Document responseDoc;
            Optional<ErrorDetail> error = determineCustomerRetrievalError(params);
            if (error.isPresent()) {
                responseDoc = loadAndParseXml(ServiceConstants.Paths.ERROR_XML_PATH_FOR_CUSTOMER_RETRIEVAL);
                applyErrorResponse(responseDoc, xpath, error.get(), params.originalTxnId());
            } else {CustomerNameMapping matched = CustomerNameMapping.fromIdentifier(params.identifier());
                if (matched != null) {
                    responseDoc = loadAndParseXml(STATIC_RESPONSE_PATH);
                    updateName(responseDoc, xpath, matched.getFirstName(), matched.getLastName(),matched.getPrefixType());
                    logger.info("Returning matched customer response for IBAN: {}", matched.getIban());
                } else {
                    responseDoc = loadAndParseXml(ServiceConstants.Paths.ERROR_XML_PATH);
                    applyErrorResponse(responseDoc, xpath, ErrorConstants.ERR_CUSTOMER_NOT_FOUND.detail(), params.originalTxnId());}}
            ByteArrayOutputStream out = new ByteArrayOutputStream();
            TransformerFactory transformerFactory = TransformerFactory.newInstance();
            transformerFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD,"");
            transformerFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET,"");
            Transformer transformer = transformerFactory.newTransformer();
            transformer.transform(new DOMSource(responseDoc), new StreamResult(out));
            ((SaajSoapMessage) message).getSaajMessage().getSOAPPart()
                    .setContent(new StreamSource(new ByteArrayInputStream(out.toByteArray())));
        } catch (Exception e) { logger.error("Customer retrieval failed", e);
            throw new AccountValidationException("Customer retrieval failed", e);}}



-----------------
 /**
     * Handles removal of <refRequestIds> node if <requestIds> is missing or empty.
     */
    private static void handleRefRequestIds(Document errorDoc, Document requestDoc, String txnId, String systemId) {
        Node requestIds = SoapInterceptorUtils.getNode(requestDoc, "requestIds");
        boolean isEmpty = isNodeEmpty(requestIds);
        Node refRequestIds = SoapInterceptorUtils.getNode(errorDoc, "refRequestIds");
        if (isEmpty  && refRequestIds != null) {
            refRequestIds.getParentNode().removeChild(refRequestIds);
            return;}
        if (refRequestIds != null) {
            if (txnId == null) removeNodes(refRequestIds, TAG_TRANSACTION_ID);
            if (systemId == null) removeNodes(refRequestIds, SYSTEM_ID);
            if (!refRequestIds.hasChildNodes()) {
                refRequestIds.getParentNode().removeChild(refRequestIds);
            }}
    }
